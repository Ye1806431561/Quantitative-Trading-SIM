# 虚拟货币量化交易模拟盘实施计划（AI 开发者指令版）

## 里程碑
- M1（第2周末）：完成基础框架、依赖、配置、日志、数据库初始化。
- M2（第5周末）：完成回测引擎、撮合引擎、风险控制、核心策略样例。
- M3（第7周末）：完成性能分析、可视化、CLI 全链路操作。
- M4（第8周末）：文档、测试与回归检查通过，具备发布条件。

## 执行步骤与验收

### Phase 0：范围与基础
1. 建立需求追踪清单，将产品需求逐项映射到模块与交付物，标记可选/必选范围。验收：清单覆盖全部需求且每项有归属与范围标注；清单新增“数据路径约束”项并明确 write-path=SQLite、read-path（回测/实时）=SQLite、CSV/Parquet 仅用于 import/export/backup。
2. 明确最小可用范围（仅 CLI 与模拟盘，不含 Web），更新清单并记录范围排除项。验收：清单中可选项清晰可见且有排除理由。
3. 按技术栈推荐结构创建目录与占位文件（不含代码），保持命名一致。验收：目录树与技术栈文档逐项比对无缺项。
4. 写入依赖清单，锁定指定版本并保存于 requirements 文件。验收：依赖列表与技术栈文档逐项一致且无额外库；Python 基线明确为 3.10+，所有依赖需与该版本兼容。
5. 创建配置模板（config.yaml、strategies.yaml、.env.example），字段与文档一致。验收：逐字段核对需求与技术栈字段无缺漏。
6. 设计配置加载与优先级规则（默认值 < YAML < 环境变量），并记录校验规则。验收：使用三组配置场景手工走查结果符合优先级。
7. 设计日志方案（分级、终端+文件、轮转、格式），记录在说明文档。验收：通过触发各级日志的手工演练确认落地策略。

### Phase 1：数据层与存储
8. 设计数据库连接生命周期（打开、关闭、事务），路径取自配置。验收：演练一次打开/提交/回滚/关闭流程无资源泄露。
9. 定义并审核表结构（accounts、orders、trades、strategy_runs、positions、candles），确保字段与需求一致。验收：初始化后六张表存在，字段/UNIQUE/CHECK/索引与 CLAUDE.md 行 387–520 一致。
   - positions：id PK 自增；symbol TEXT NOT NULL UNIQUE；amount REAL NOT NULL；entry_price REAL NOT NULL；current_price REAL；unrealized_pnl REAL；realized_pnl REAL DEFAULT 0；opened_at TIMESTAMP；updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP；CHECK(amount ≥ 0)；索引 idx_positions_symbol(symbol)；用途：持仓持久化与崩溃恢复。
   - candles：id PK 自增；symbol TEXT NOT NULL；timeframe TEXT NOT NULL；timestamp INTEGER NOT NULL（毫秒）；open/high/low/close/volume REAL NOT NULL；created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP；UNIQUE(symbol, timeframe, timestamp)；索引 idx_candles_symbol_time(symbol, timeframe, timestamp)、idx_candles_timestamp(timestamp)；用途：统一历史与实时 K 线存储。
10. 定义领域模型与校验规则（必填、数值范围、状态枚举），记录在模型说明。验收：正反例清单覆盖各字段并通过校验测试。
11. 实现账户初始化与余额管理流程（多币种、可用/冻结、总资产估值计算，启动时依 positions 表恢复持仓状态）。验收：固定输入下账户余额与总资产计算可复现。
12. 实现订单持久化接口（创建、查询、状态更新、撤销），保证幂等与一致性。验收：对每条状态流转有测试记录并结果正确。
13. 实现交易记录写入与订单关联流程，含手续费字段。验收：生成的交易记录可反查到对应订单。
14. 设计市场数据获取接口（交易所选择、限流、错误重试），记录异常处理策略。验收：模拟限流与错误场景时接口能按策略重试或失败告知；接口设计文档明确市场数据运行态写入目标仅为 SQLite，禁止运行态写入 CSV/Parquet。
15. 实现历史 K 线下载与本地存储（周期、命名规范、时间范围，写入目标表 candles）。验收：下载后的 K 线数据写入 SQLite 并可按 symbol/timeframe/time range 查询，时间序正确；CSV/Parquet 仅通过 import/export/backup 流程产生，不作为运行态存储。
16. 增加历史数据缓存与去重机制，避免重复下载/写入。验收：重复请求同一数据时 SQLite 中记录不增加（基于去重约束）；CSV/Parquet 不参与运行态缓存与去重判定。

### Phase 2：撮合、风险与行情
17. 实现实时行情拉取接口（最新价、深度、K 线），带错误兜底与超时。验收：在模拟数据源下各接口返回结构一致。
18. 实现价格服务，用最新行情进行资产估值与持仓评估。验收：给定固定行情输入时估值结果与手算一致。
19. 实现市价单撮合逻辑（按最新价成交），同步账户与订单状态。验收：固定价格序列下成交结果可复算。
20. 实现限价单挂单队列与触发规则，包含队列管理与撮合。验收：价格跨越挂单价时订单正确成交或保持挂单。
21. 实现止损/止盈触发机制，并与订单状态机联动。验收：价格触发阈值时状态转换符合规则。
22. 实现手续费与滑点计算（区分 Maker/Taker），写入交易记录。验收：用已知参数计算结果与预期一致。
23. 实现订单状态机（新建、挂单、部分成交、成交、撤单、拒单），定义合法流转表。验收：每条流转路径的测试用例通过。
24. 实现风险控制（单笔仓位、总仓位、最大回撤），下单前拦截超限请求。验收：超阈值交易被拒单并记录原因。

### Phase 3：策略与双引擎
25. 设计策略接口生命周期（初始化、运行、停止、订单/成交回调），形成文档。验收：最小示例策略按生命周期触发。
26. 集成 Backtrader 回测引擎，支持 Pandas 数据馈送。验收：小样本回测可产出基础统计，且回测数据读取路径仅来自 SQLite（非 CSV/Parquet 运行态读取）。
27. 挂载标准分析器（夏普、回撤、交易统计、收益率、时间序列收益），统一结果结构。验收：每个分析器均有输出且字段完整。
28. 输出回测结果（报告、交易明细、资金曲线数据），支持 CSV 与 JSON。验收：生成文件存在且字段匹配设计。
29. 实现实时模拟主循环（行情拉取→策略执行→下单→撮合→持仓更新）。验收：使用模拟行情驱动一轮完整闭环，实时模式的策略输入读取路径为 SQLite（先落 SQLite 再供读取），CSV/Parquet 不参与运行态读取。
30. 实现策略适配器，使回测策略可在实时引擎复用。验收：同一策略在两种模式下信号一致。
31. 实现内置策略：双均线，支持参数化与双模式。验收：固定数据集上产生预期数量信号。
32. 实现内置策略：网格，支持参数化与双模式。验收：震荡数据上产生网格挂单与成交。
33. 实现内置策略：布林带，支持参数化与双模式。验收：波动数据上按阈值触发交易。
34. 实现策略参数管理，从配置加载并传递到策略实例。验收：修改配置后策略参数实际生效。

### Phase 4：接口、监控与质量
35. 实现性能分析模块（总收益、年化、最大回撤、夏普、索提诺、胜率、盈亏比）。验收：对已知资金曲线计算值与手算一致。
36. 实现可视化输出（资金曲线、回撤曲线、交易分布、持仓时间），导出本地图片。验收：文件存在且包含预期曲线。
37. 实现 CLI 命令集合（启动、停止、状态、余额、订单、回测、下载、实时模拟、positions、import、export、cleanup、reconcile、status --disk），覆盖必要参数校验与帮助信息。验收：每个命令在缺参和正确入参时均返回可解释结果。
38. 实现运行状态与监控输出（策略状态、账户变化、异常告警），含日志与状态查询接口。验收：模拟异常与状态变化时输出可观测；同时验证 API 密钥加密存储、日志脱敏、网络断线自动重连、策略崩溃隔离四项安全/可靠性要求。
39. 建立单元与集成测试套件，覆盖账户、撮合、策略、回测、实时引擎关键路径。验收：全量测试运行通过且覆盖率记录。
40. 进行性能基准（回测速度、实时延迟）并与非功能指标对齐，记录差距改进项。验收：回测 1 年 1h K 线硬性目标 <5s，<10s 仅为降级容忍且需记录原因；基准测试需注明条件：1h K 线、单策略、默认指标集、单交易对、SQLite 本地、禁用 I/O 打印。
41. 更新 README/使用文档，涵盖环境搭建、数据下载、回测、实时模拟全流程。验收：按文档步骤可独立跑通一次回测与实时模拟。
42. 回归检查：逐条对照需求追踪清单，确认已完成或标注可选并给出理由。验收：清单无遗漏项。
