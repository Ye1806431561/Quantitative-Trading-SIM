# 进度归档 - 2026-02-17

## 2026-02-17（第 8 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 1 第 8 条：设计数据库连接生命周期（打开、关闭、事务），并确保数据库路径取自配置。

### 已完成事项
- 完整阅读并复核 `memory-bank/` 全部文档，确认第 8 步边界与验收口径。
- 完成数据库生命周期实现：
  - `src/core/database.py`：
    - 新增 `SQLiteDatabase` 生命周期管理器。
    - 实现 `open()` / `close()`。
    - 实现 `transaction()` 上下文管理，覆盖自动提交与异常回滚。
    - 实现 `from_config()`，从 `system.database_path` 构建数据库连接管理器。
    - 提供连接状态与上下文管理能力（`is_open`、`__enter__`/`__exit__`）。
- 新增第 8 步验收测试：
  - `tests/test_database.py`：
    - 验证数据库路径来自配置。
    - 验证打开→提交→关闭流程。
    - 验证异常触发回滚。
    - 验证关闭幂等与未打开连接保护。
- 你已确认第 8 步“通过”（2026-02-17）。

### 验收状态
- Phase 1 第 8 条已验证通过。
- 按你的约束未开始第 9 步（表结构定义与审核）。

### 交接备注
- 数据层已具备基础连接生命周期与事务边界，可作为第 9 步建表与索引实现的底座。
- 下一步进入第 9 步时，应仅落地 `accounts`、`orders`、`trades`、`strategy_runs`、`positions`、`candles` 六表及其约束/索引，不跨步实现第 10 步。

## 2026-02-17（第 9 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 1 第 9 条：定义并审核表结构（`accounts`、`orders`、`trades`、`strategy_runs`、`positions`、`candles`），确保字段与需求一致。

### 已完成事项
- 完整阅读并复核 `memory-bank/` 全部文档，确认第 9 步边界与验收口径（含 `CLAUDE.md` 行 387–520）。
- 在 `src/core/database.py` 实现第 9 步建表与建索引能力：
  - 新增六张核心表的 `CREATE TABLE IF NOT EXISTS` 语句。
  - 新增 `positions` 约束与索引：`UNIQUE(symbol)`、`CHECK(amount >= 0)`、`idx_positions_symbol`。
  - 新增 `candles` 约束与索引：`UNIQUE(symbol, timeframe, timestamp)`、`idx_candles_symbol_time`、`idx_candles_timestamp`。
  - 新增 `initialize_schema()`，在事务内统一执行建表与建索引。
- 扩展 `tests/test_database.py` 以固化第 9 步验收：
  - 校验六张表存在与字段完整性。
  - 校验 `trades.order_id -> orders.id` 外键存在并生效。
  - 校验 `positions` 的 `UNIQUE/CHECK` 生效。
  - 校验 `candles` 复合 `UNIQUE` 生效。
- 完成验证：
  - 使用 `PYTHONPATH=. ./.venv/bin/pytest -q tests/test_database.py`，结果 `11 passed`。
  - 通过 SQLite `sqlite_master` 元数据抽查，确认三条索引与六张表 SQL 落地。
- 你已确认第 9 步“通过”（2026-02-17）。

### 验收状态
- Phase 1 第 9 条已验证通过。
- 按你的约束未开始第 10 步（领域模型与校验规则）。

### 交接备注
- 数据层已完成“生命周期 + 核心表结构”基线，可进入第 10 步的模型与规则定义。
- 第 10 步开始前应保持范围边界，仅新增领域模型与校验，不提前实现账户/订单业务流程。

## 2026-02-17（第 10 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 1 第 10 条：定义领域模型与校验规则（必填、数值范围、状态枚举），形成可复用的模型层。

### 已完成事项
- 完整阅读并复核 `memory-bank/` 全部文档，确认第 10 步边界与验收口径。
- 实现领域模型与校验规则（分文件，避免大文件）：
  - `src/core/enums.py`：订单类型/方向/状态、交易方向、策略运行状态枚举。
  - `src/core/validation.py`：通用校验函数与 `DomainValidationError`。
  - 领域模型（含 `validate` 类方法）：`account.py`、`order.py`、`trade.py`、`position.py`、`candle.py`、`strategy_run.py`。
  - 规则覆盖：必填校验、正数/非负数、比例(0,1]、价格高低开收关系、时间戳非负与先后约束、订单 filled 不超 amount、非市价单必须给 price、K 线 timeframe 白名单复用配置。
- 新增自动化测试 `tests/test_models.py`，覆盖 14 项正反例；全量测试 `PYTHONPATH=. ./.venv/bin/pytest -q` 通过（33 passed）。

### 验收状态
- Phase 1 第 10 条已完成且本地测试通过。
- 按约定未开始第 11 步（账户初始化与余额管理）。

### 交接备注
- 第 11 步可直接使用已校验的模型与枚举，避免魔法字符串与重复校验逻辑。
- 如需扩展字段或新枚举，请同步更新 `validation.py` 与对应模型测试。

## 2026-02-17（第 11 步验证与 Bug 修复）

### 本次目标
- 验证第 11 步（账户初始化与余额管理）的完成状况。
- 修复验证过程中发现的测试失败。

### 已完成事项
- 确认 `src/core/account_service.py`（232 行）已实现第 11 步核心功能：
  - `AccountService`：账户生命周期管理（初始化、查询、余额变更）。
  - `initialize_accounts()`：幂等创建账户行。
  - `freeze_funds()` / `release_funds()`：可用/冻结资金互转。
  - `deposit()` / `consume_available()` / `add_to_available()`：余额增减。
  - `load_positions()`：从 `positions` 表恢复持仓状态。
  - `compute_total_assets()`：多币种总资产估值（现金 + 持仓市值）。
  - `from_config()`：从配置初始化服务。
- 确认 `tests/test_account.py` 包含 5 项验收测试。
- 运行测试发现 2 项失败（`test_compute_total_assets_uses_positions`、`test_compute_total_assets_requires_price_when_missing_current_price`）。
- 定位根因：`src/core/validation.py` 的 `require_timestamp()` 仅接受 `int/float`，但 `database.py` 使用 `detect_types=sqlite3.PARSE_DECLTYPES` 导致 `TIMESTAMP` 列自动解析为 `datetime.datetime` 对象。
- 修复 `src/core/validation.py` 中的 `require_timestamp()`，新增：
  - `datetime.datetime` 对象支持（SQLite `PARSE_DECLTYPES` 产生）。
  - ISO 格式字符串支持（降级兼容）。
- 修复后全量测试通过：`38 passed`（含 `test_account` 5 项、`test_models` 14 项、`test_database` 11 项、`test_config` 5 项、`test_logger` 3 项）。

### 验收状态
- 第 11 步代码与测试实现已存在，Bug 已修复，全量测试通过。
- 第 11 步已验证通过（2026-02-17）。
- 按约定未开始第 12 步（订单持久化接口）。

### 交接备注
- `require_timestamp()` 现兼容三种时间戳来源：数值、`datetime` 对象、ISO 字符串。后续新增时间戳字段时无需额外适配。
- 3 条 `DeprecationWarning`（Python 3.12 弃用旧版 timestamp converter）为已知问题，不影响功能。
- 账户服务（`AccountService`）已就绪，第 12 步订单持久化可直接调用其余额检查方法（需扩展）。

## 2026-02-17（第 12 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 1 第 12 条：实现订单持久化接口（创建、查询、状态更新、撤销），保证幂等与一致性。

### 已完成事项
- 完整阅读并复核 `memory-bank/` 全部文档，确认第 12 步边界与验收口径。
- 实现订单持久化服务（`src/core/order_service.py`）：
  - `OrderService`：订单生命周期管理（创建、查询、状态更新、撤销）。
  - `create_order()`：创建订单并冻结资金（买单），当调用方提供 `order_id` 时支持幂等性。
  - `get_order()` / `list_orders()`：按 ID 查询或按条件过滤（symbol、status、limit）。
  - `update_order_status()`：状态流转校验（PENDING→OPEN→PARTIALLY_FILLED→FILLED/CANCELED/REJECTED），部分成交时消耗冻结资金，REJECTED 释放冻结资金。
  - `cancel_order()`：撤销订单并释放未成交部分的冻结资金，支持幂等性。
  - 状态机校验：定义合法流转表，拒绝非法状态转换。
  - 资金管理：买单创建时冻结资金，部分成交时消耗冻结资金，取消或 REJECTED 时释放剩余冻结资金。
  - 事务边界：移除 `update_order_status()` 内部嵌套 `with tx:`，保持单层事务。
- 修复 `orders` 表结构：将 `created_at` 和 `updated_at` 从 `TIMESTAMP` 改为 `INTEGER`（存储毫秒级时间戳），避免 SQLite `PARSE_DECLTYPES` 解析冲突。
- 新增 `tests/test_order_service.py`，覆盖 24 项验收测试：
  - 订单创建：冻结资金、参数校验、资金不足拒绝、`order_id` 幂等校验。
  - 订单查询：按 ID、按 symbol、按 status、limit 分页。
  - 状态更新：合法流转、非法流转拒绝、filled 超限拒绝、REJECTED 释放冻结资金。
  - 订单撤销：释放冻结资金、部分成交后释放剩余、幂等性。
- 全量测试通过：62 passed（3 warnings，含 24 项订单服务测试、38 项之前的测试）。

### 验收状态
- Phase 1 第 12 条已完成且全量测试通过。
- 等待用户验证后开始第 13 步（交易记录写入与订单关联）。

### 交接备注
- 订单服务已实现完整的状态机与资金管理，可作为第 13 步交易记录写入的基础。
- 订单状态流转与资金冻结/消耗/释放逻辑已通过 24 项测试固化，后续修改需同步更新测试。
- REJECTED 释放冻结资金与撤单一致，避免冻结资金长期占用。
- `update_order_status()` 保持单层事务，避免嵌套 savepoint 语义偏差。
- 第 13 步需实现交易记录写入（`trades` 表）并与订单关联，包含手续费字段。

## 2026-02-17（第 13 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 1 第 13 条：实现交易记录写入与订单关联流程，含手续费字段。

### 已完成事项
- 更新数据库 schema：
  - `trades.timestamp` 改为 `INTEGER NOT NULL`，默认毫秒级时间戳，便于统一解析。
  - 新增索引 `idx_trades_order_id` 提升按订单查询成交记录的性能。
- 新增交易记录服务 `src/core/trade_service.py`：
  - `TradeService.record_trade()`：校验输入、插入 `trades` 记录（含 `fee`）、校验订单状态（仅允许 `open/partially_filled`）、防止 overfill、按订单价格消费冻结资金（买单）、更新订单 `filled` 与状态（部分成交→`partially_filled`，全部成交→`filled`）。
  - `TradeService.list_trades_for_order()`：按订单 ID 查询成交记录，倒序返回。
- 复用/抽象资金消耗逻辑：
  - 在 `OrderService` 中抽出 `_consume_frozen_funds()`，供状态更新与成交写入共用，避免重复代码。
- 新增自动化测试 `tests/test_trade_service.py` 覆盖：
  - 成交记录写入与订单关联。
  - 部分成交/完全成交后订单 `filled` 与状态更新。
  - overfill 拒绝、缺失订单拒绝。

### 测试情况
- 已通过临时脚本 `tests/run_tests_manual.py`手动运行测试，全量通过：
  - `test_record_trade_persists_and_links_order`: PASS
  - `test_record_trade_updates_filled_amount_and_status`: PASS
  - `test_record_trade_rejects_overfill`: PASS
  - `test_record_trade_requires_existing_order`: PASS

### 验收状态
- Phase 1 第 13 步已完成且测试通过。
- 交易记录与订单关联功能验证正常。
- 等待开始 Phase 1 第 14 步（市场数据接口设计）。

### 交接备注
- 资金流转：成交写入会按订单价格消费冻结资金（买单），与第 12 步的资金冻结/消耗逻辑保持一致。
- 时间戳：`trades.timestamp` 统一为毫秒整数，避免 SQLite `PARSE_DECLTYPES` 解析差异。
- 若测试需运行：先 `pip install -r requirements.txt`，再 `pytest`.

## 2026-02-17（第 14 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 1 第 14 条：设计市场数据获取接口（交易所选择、限流、错误重试），并记录异常处理策略与运行态数据路径约束。

### 已完成事项
- 完整阅读并复核 `memory-bank/` 全部文档，确认第 14 步边界与验收口径。
- 落地市场数据接口实现：
  - `src/data/market.py`：
    - 实现 `MarketDataFetcher` 统一接口（`fetch_ticker` / `fetch_order_book` / `fetch_ohlcv`）。
    - 支持 `from_config()` 基于配置选择交易所与限流开关。
    - 支持 `from_exchange()` 注入式构建，便于模拟与测试。
    - 实现失败告知：重试耗尽或不可重试错误时抛出 `MarketDataFetchError`，包含尝试次数与错误类型。
  - `src/data/market_policy.py`：
    - 定义 `RetryPolicy`、`ExchangeSettings`、`MarketDataConfigError`。
    - 定义并校验运行态写入目标：`market_data.runtime_write_target` 仅允许 `sqlite`。
    - 明确 `csv/parquet` 仅用于 import/export/backup。
  - `src/data/market_retry.py`：
    - 实现 `RequestRateLimiter` 本地限流器。
    - 实现错误分类：限流类、可重试网络类、不可重试类。
- 新增自动化测试 `tests/test_market_data.py`，覆盖第 14 步验收场景：
  - 交易所选择与配置生效。
  - 限流错误重试后成功。
  - 网络错误重试耗尽后失败告知。
  - 不可重试错误快速失败。
  - 本地限流在连续请求间生效。
  - 非 SQLite 运行态写入目标被拒绝。
- 同步补齐市场数据配置基线：
  - `config/config.yaml` 新增 `market_data` 配置段（运行态写入目标 + retry 参数）。
  - `src/utils/config_defaults.py` 新增 `market_data` 默认值，允许配置加载器识别该配置段。
  - `src/utils/config_validation.py` 增加 `market_data` 校验规则，拒绝非 `sqlite` 运行态写入目标。
  - `tests/test_config.py` 新增反例测试，验证 `runtime_write_target=csv` 会被拒绝。
- 新增接口设计文档 `memory-bank/market-data-interface-design.md`，记录限流/重试/异常策略与数据路径约束声明。

### 测试情况
- 已通过临时脚本 `tests/run_tests_market_manual.py` 手动运行测试，全量通过：
  - `test_from_config_selects_exchange`: PASS
  - `test_fetch_ticker_retries_on_rate_limit_then_succeeds`: PASS
  - `test_fetch_ticker_fails_after_retry_limit`: PASS
  - `test_fetch_ticker_fails_fast_on_non_retryable_error`: PASS
  - `test_rate_limiter_waits_between_requests`: PASS
  - `test_runtime_write_target_rejects_csv`: PASS

### 验收状态
- Phase 1 第 14 步接口设计与异常策略实现已验证通过。
- 交易所适配、限流、重试策略符合设计要求。
- 等待开始 Phase 1 第 15 步（历史 K 线下载与存储）。

### 交接备注
- 第 14 步仅覆盖接口设计与异常策略，不包含历史数据下载落库实现。
- 在你确认第 14 步测试通过前，保持第 15 步不启动。

## 2026-02-17（第 15 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 1 第 15 条：实现历史 K 线下载与本地存储（周期、命名规范、时间范围，写入目标表 `candles`）。

### 已完成事项
- 完整阅读并复核 `memory-bank/` 全部文档后开始实现第 15 步（按你的要求不启动第 16 步）。
- 实现历史数据存储服务 `src/data/storage.py`：
  - 新增 `HistoricalCandleStorage`，提供 `download_and_store()` 与 `query_candles()`。
  - 新增 `CandleDownloadRequest` 与 `CandleDownloadResult`，明确下载参数与结果结构。
  - 支持 `symbol/timeframe/time range` 参数校验（含 timeframe 白名单与时间范围合法性）。
  - 按时间游标分批调用 `fetch_ohlcv` 拉取历史 K 线，并写入 SQLite `candles` 表。
  - 提供按 `symbol/timeframe/time range` 查询接口，结果按 `timestamp ASC` 返回。
  - 新增命名规范方法 `build_dataset_name()`，统一生成如 `BTC_USDT_1h` 的数据集标识。
- 新增自动化测试 `tests/test_storage.py`，覆盖第 15 步关键验收路径：
  - 下载分页拉取并落库到 `candles` 表。
  - 按时间范围查询结果正确且时间序升序。
  - 非法时间范围、非法周期、非法 OHLCV 结构拒绝。
- 本地测试结果：
  - `PYTHONPATH=. ./.venv/bin/pytest -q tests/test_storage.py` → `5 passed`
  - `PYTHONPATH=. ./.venv/bin/pytest -q tests/test_database.py tests/test_market_data.py tests/test_storage.py` → `22 passed`

### 验收状态
- Phase 1 第 15 步代码实现已完成，自动化测试通过。
- 等待你执行并确认测试通过后，再开始第 16 步（历史数据缓存与去重）。

### 交接备注
- 第 15 步实现仅覆盖“下载 + 写入 + 查询”能力，未实现缓存命中与去重策略（保持第 16 步边界）。
- 当前写入路径仍为 SQLite `candles` 表，未引入 CSV/Parquet 运行态写入。

## 2026-02-17（第 16 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 1 第 16 条：增加历史数据缓存与去重机制，避免重复下载/写入。

### 已完成事项
- 完整阅读并复核 `memory-bank/` 全部文档后开始实现第 16 步。
- 更新 `src/data/storage.py`：
  - 新增历史请求缓存命中逻辑（`symbol/timeframe/time range`）。
  - 命中缓存时直接返回，不重复调用 `fetch_ohlcv`。
  - K 线写入改为 `INSERT OR IGNORE`，依赖 `candles` 唯一约束做去重。
  - `downloaded_count` 改为“本次实际新增记录数”，重复数据不重复计数。
- 更新 `src/core/database.py`：
  - 新增 `candle_download_cache` 表（缓存元数据）。
  - 新增 `idx_candle_cache_lookup` 索引，支持缓存命中查询。
- 扩展 `tests/test_storage.py`：
  - 新增“重复同一请求命中缓存、不触发重复下载”用例。
  - 新增“重叠区间请求只新增未落库数据”用例。
  - 新增“新服务实例仍可命中 SQLite 持久化缓存”用例。
- 本地自检结果：
  - `PYTHONPATH=. ./.venv/bin/pytest -q tests/test_storage.py tests/test_database.py` → `19 passed`

### 验收状态
- Phase 1 第 16 步代码实现已完成，自动化测试通过。
- 按你的要求，等待你执行并确认测试通过前，不启动第 17 步。

### 交接备注
- 第 16 步缓存与去重仅基于 SQLite（`candles` + `candle_download_cache`），未引入 CSV/Parquet 运行态路径。
- 在你确认第 16 步通过前，保持第 17 步（实时行情拉取接口）未开始状态。

## 2026-02-17（第 17 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 2 第 17 条：实现实时行情拉取接口（最新价、深度、K 线），并增加错误兜底与超时控制。

### 已完成事项
- 完整阅读并复核 `memory-bank/` 全部文档后开始第 17 步实现。
- 新增实时行情服务：
  - `src/data/realtime_market.py`：
    - 新增 `RealtimeMarketDataService`。
    - 提供统一接口：`get_latest_price()`、`get_depth()`、`get_klines()`。
    - 增加请求级超时保护（线程 + timeout），超时时返回统一快照结构。
    - 增加错误兜底：优先回退到最近一次成功数据；无缓存时返回统一空结构并附错误信息。
  - `src/data/realtime_payloads.py`：
    - 定义统一返回结构 `RealtimeMarketSnapshot`（`channel/symbol/ok/fallback/timed_out/error/fetched_at_ms/data`）。
    - 统一归一化 ticker/depth/ohlcv 结构，确保三个接口输出字段格式一致。
- 更新导出入口：
  - `src/data/__init__.py` 导出 `RealtimeMarketDataService` 与 `RealtimeMarketSnapshot`。
- 新增自动化测试：
  - `tests/test_realtime_market_data.py`，覆盖：
    - 三类实时接口返回统一结构。
    - 异常时使用缓存兜底。
    - 超时时无缓存返回空结构。
    - 超时时有缓存回退到最近成功数据。
- 本地自检结果：
  - `PYTHONPATH=. ./.venv/bin/pytest -q tests/test_realtime_market_data.py tests/test_market_data.py` → `10 passed`

### 验收状态
- Phase 2 第 17 步代码实现已完成，自动化测试通过。
- 按你的要求，在你验证第 17 步测试通过前，不启动第 18 步。

### 交接备注
- 第 17 步仅实现实时行情读取接口与兜底/超时机制，不包含第 18 步价格服务估值逻辑。
- 本次为遵守 `CLAUDE.md` 单文件行数约束（<300 行），将实时模块拆分为 `realtime_market.py`（流程编排）和 `realtime_payloads.py`（结构与归一化）。

## 2026-02-17（第 18 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 2 第 18 条：实现价格服务，用最新行情进行资产估值与持仓评估。

### 已完成事项
- 完整阅读并复核 `memory-bank/` 全部文档后开始第 18 步实现（按你的要求不启动第 19 步）。
- 新增价格服务实现：
  - `src/live/price_service.py`：
    - 新增 `PriceService`，统一执行“最新价获取 → 持仓评估 → 资产估值”流程。
    - 使用实时行情最新价评估持仓 `market_value` 与 `unrealized_pnl`。
    - 回写 `positions.current_price` 与 `positions.unrealized_pnl`，保证估值后持仓状态可持久化。
    - 当实时最新价缺失时，回退使用 `positions.current_price`；两者都缺失则抛错，避免静默错误估值。
    - 输出聚合结果 `PortfolioValuation`（`base_cash`、`positions_value`、`total_assets`）。
  - `src/live/__init__.py` 导出 `PriceService`、`PortfolioValuation`、`PositionAssessment`。
- 新增自动化测试：
  - `tests/test_price_service.py`，覆盖：
    - 固定行情输入下估值结果与手算一致（第 18 步核心验收）。
    - 最新价缺失时使用持仓缓存价回退。
    - 最新价与持仓缓存价均缺失时报错。
- 本地自检结果：
  - `PYTHONPATH=. ./.venv/bin/pytest -q tests/test_price_service.py tests/test_account.py tests/test_realtime_market_data.py` → `12 passed`

### 验收状态
- Phase 2 第 18 步代码实现已完成，自动化测试通过。
- 按你的要求，等待你执行并确认测试通过前，不启动第 19 步。

### 交接备注
- 第 18 步仅覆盖“估值与持仓评估”能力，不包含市价单撮合逻辑（第 19 步边界）。
- 估值流程复用 `AccountService.compute_total_assets()`，保持账户总资产口径一致。

## 2026-02-17（第 19 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 2 第 19 条：实现市价单撮合逻辑（按最新价成交），并同步账户与订单状态。

### 已完成事项
- 完整阅读并复核 `memory-bank/` 全部文档后开始第 19 步实现（按你的要求不启动第 20 步）。
- 新增市价单撮合引擎：
  - `src/core/matching.py`：
    - 新增 `MatchingEngine`、`MarketOrderRequest`、`MarketOrderMatchResult`。
    - 实现 `execute_market_order()`：按最新价执行市价单，撮合路径为 `pending -> open -> filled`。
    - 复用 `OrderService` + `TradeService` 完成订单创建、状态推进、成交落库。
    - 实现账户同步：买单增加基础币，卖单减少基础币并增加报价币。
    - 实现持仓同步：买单新建/加仓并重算加权成本；卖单减仓并更新 `realized_pnl/unrealized_pnl`。
    - 增加失败保护：最新价缺失、卖单库存不足时拒绝撮合。
- 新增自动化测试：
  - `tests/test_matching.py`，覆盖：
    - 市价买单按最新价成交并同步账户/持仓。
    - 固定价格序列下连续成交结果可复算。
    - 最新价缺失时失败且不写入订单/成交。
    - 卖单库存不足时失败且不写入订单/成交。
- 本地自检结果：
  - `PYTHONPATH=. ./.venv/bin/pytest -q tests/test_matching.py tests/test_trade_service.py tests/test_order_service.py` → `29 passed`

### 验收状态
- Phase 2 第 19 步代码实现已完成，自动化测试通过。
- 按你的要求，等待你执行并确认测试通过前，不启动第 20 步。

### 交接备注
- 第 19 步仅覆盖“市价单即时撮合 + 账户/订单/持仓同步”，未实现限价挂单队列与触发撮合（第 20 步边界）。
- 交易手续费与滑点仍为后续步骤（第 22 步）实现；当前市价撮合默认手续费为 `0.0`。

## 2026-02-17（第 20 步）

### 本次目标
- 执行 `implementation-plan.md` Phase 2 第 20 条：实现限价单挂单队列与触发规则，包含队列管理与撮合。

### 已完成事项
- 完整阅读并复核 `memory-bank/` 全部文档后开始第 20 步实现（按你的要求不启动第 21 步）。
- 新增限价撮合引擎：
  - `src/core/limit_matching.py`：
    - 新增 `LimitOrderMatchingEngine`、`LimitOrderRequest`、`LimitOrderMatchResult`、`LimitOrderSweepResult`。
    - 实现 `place_limit_order()`：创建限价单并推进到 `open` 挂单状态。
    - 实现 `list_open_limit_orders()`：按价格-时间优先级返回挂单队列（买单价高优先、卖单价低优先、同价按创建时间）。
    - 实现 `process_limit_order_queue()`：按最新价扫描并触发成交，买单触发条件 `latest_price <= limit_price`，卖单触发条件 `latest_price >= limit_price`。
    - 未触发或库存不足的订单保持挂单，等待下一次行情触发。
  - `src/core/limit_settlement.py`：
    - 新增 `LimitOrderSettlement`，封装限价成交后的账户与持仓结算。
    - 实现买单加仓与均价重算、卖单减仓与已实现盈亏更新。
    - 保持与现有 `OrderService`/`TradeService` 的事务一致性。
- 新增自动化测试：
  - `tests/test_limit_matching.py`，覆盖：
    - 价格未跨越时订单保持挂单；
    - 价格跨越买单挂单价后成交；
    - 价格跨越卖单挂单价后成交；
    - 买单队列价格-时间优先级。
    - 买单价格改善：限价高于市场价时按市场价成交并返还差价。
- 本地自检结果：
  - `PYTHONPATH=. ./.venv/bin/pytest -q tests/test_limit_matching.py` → `5 passed`
  - `PYTHONPATH=. ./.venv/bin/pytest -q tests/test_matching.py` → `4 passed`（第 19 步回归通过）

### 验收状态
- Phase 2 第 20 步代码实现已完成，自动化测试通过。
- 用户已确认第 20 步验收通过（2026-02-17）。
- 尚未开始第 21 步，等待下一步指令。

### 交接备注
- 第 20 步仅覆盖“限价挂单队列 + 触发撮合 + 账户/持仓同步”，未实现止损/止盈触发（第 21 步边界）。
- 当前成交价格采用“对用户更优的市场价”结算（买单更低价、卖单更高价），手续费仍为 `0.0`（第 22 步再补齐手续费/滑点）。

### 第20步补丁（价格改善修复）
- 修复“限价单无价格改善”问题：
  - 在 `src/core/limit_matching.py` 中，触发后成交价改为对用户更优的市场价（买单更低价、卖单更高价）。
  - 对买单增加差价返还：当 `execution_price < limit_price` 时，将 `(limit_price - execution_price) * amount` 返还到报价币 `available/balance`。
- 验证结果：
  - `tests/test_limit_matching.py` 新增 `test_limit_buy_price_improvement_refunds_difference`，覆盖“50000 限价、40000 市价”差价返还场景。
  - 本地测试：`PYTHONPATH=. ./.venv/bin/pytest -q tests/test_limit_matching.py`（5 passed）。

### 第20步补丁（卖单库存预检修复）
- 修复“无持仓也可挂出限价卖单”问题：
  - 在 `src/core/limit_matching.py` 的 `place_limit_order()` 增加卖单下单前库存预检。
  - 当基础币 `available` 或 `positions.amount` 不足时，直接拒绝下单并报错，不进入 `OPEN` 队列。
- 验证结果：
  - `tests/test_limit_matching.py` 新增 `test_place_limit_sell_rejects_when_inventory_missing`。
  - 本地测试：`PYTHONPATH=. ./.venv/bin/pytest -q tests/test_limit_matching.py`（6 passed）。
